---
log-level: debug

# Repos to search
source:
  provider: github
  organization: pantheon-systems
  # repos: ['titan-mt', 'infrastructure'] # Uncomment to only search certain repos
  exclude-repos: ['drupal', 'Wordpress']
  token: # Set this using the `--source.token=TOKENVALUE` command parameter

#earliest-commit: f45188308b6c4877941e83ed0214f85e54be4324
#latest-commit: f45188308b6c4877941e83ed0214f85e54be4324

# Directories (relative to cwd with command is run)
output-dir: ./output
whitelist-secret-dir: ./whitelist

# Whitelist files that match any
whitelist-path-match:
  # By extension
  - '\.(?:eps|eot|jpe?g|png1?|ico|svg|gif|psd|tar|tar\.gz|tgz|zip|rar|woff2?|ttf|p12|mp4|mp3|hpi|sqlite3?|pyc|db|tf|
  DS_Store|lock|min\.js|slim\.js|js\.map|egg|otf|phar|sketch|pdf|crdownload)$'

  # Tests
  - '_[Tt]ests?\..{3,4}$'
  - '\/[Tt]ests?\/'
  - '^[Tt]ests?\/'
  - '\/spec\/'
  - '^spec\/'

  # Misc
  - '^LICENCE$'

# Rules
rules:
  - name: slack-token
    processor: regex
    regex: '(xox[p|b|o|a]-[0-9]{12}-[0-9]{12}-[0-9]{12}-[a-z0-9]{32})'
  - name: facebook-oauth
    processor: regex
    regex: '[f|F][a|A][c|C][e|E][b|B][o|O][o|O][k|K].*[''|"][0-9a-f]{32}[''|"]'
  - name: twitter-oauth
    processor: regex
    regex: '[t|T][w|W][i|I][t|T][t|T][e|E][r|R].*[''|"][0-9a-zA-Z]{35,44}[''|"]'
  - name: github
    processor: regex
    regex: '[g|G][i|I][t|T][h|H][u|U][b|B].*[''|"][0-9a-zA-Z]{35,40}[''|"]'
    whitelist-code-match:
      # Check cookbook definition, git ref
      - ':ref => ''([^'']+)'''
      - '(github" data-branch="[0-9a-z]{41}")'
  - name: google-oauth
    processor: regex
    regex: '("client_secret":"[a-zA-Z0-9-_]{24}")'
  - name: heroku-api-key
    processor: regex
    regex: '[h|H][e|E][r|R][o|O][k|K][u|U].*[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}'
  - name: slack-webhook
    processor: regex
    regex: 'https://hooks.slack.com/services/T[a-zA-Z0-9_]{8}/B[a-zA-Z0-9_]{8}/[a-zA-Z0-9_]{24}'
  - name: gcp-service-account
    processor: regex
    regex: '"type": "service_account"'
  - name: twilio-api-key
    processor: regex
    regex: 'SK[a-z0-9]{32}'
  - name: password-in-url
    processor: regex
    regex: '[a-zA-Z]{3,10}://[^/\s:@]{3,20}:[^/\s:@]{3,20}@[^''"\s]+'
    whitelist-code-match:
      # Curly braces like https://username:{pass}@host.com
      - '://[^/\s:@]{3,20}:\{[^/\s:@]{1,20}\}@'

      # Dollar variable like https://username:$db_pass@host.com
      - '://[^/\s:@]{3,20}:\$db_pass@'

      - '://user:pass@'
      - '://myuser:EXTRA_S3CUR3_PASS@'
      - '://user:password@'
      - '://username:password@'
      - '://USERNAME:PASSWORD@'
      - '://bob:loblaw@'
      - '://test:secret@'
      - '://<strong>Me:Secret@'
      - '://proxy_user:proxy_pass@'
      - '://\[user:pass@\]'
  - name: generic-secret
    processor: regex
    regex: '[s|S][e|E][c|C][r|R][e|E][t|T].*[''|"][0-9a-zA-Z]{32,45}[''|"]'
    whitelist-code-match:
      - '(secret_key": "klasjdflkasjdfalskdfjadfasdfasdfasdf")'
  - name: generic-api-key
    processor: regex
    regex: '[a|A][p|P][i|I][_]?[k|K][e|E][y|Y].*[''|"][0-9a-zA-Z]{32,45}[''|"]'

  - name: rsa-private-key-pem
    processor: pem
    pem-type: RSA PRIVATE KEY
    whitelist-code-match:
      # Incomplete/invalid/example keys
      - '-----BEGIN RSA PRIVATE KEY-----.{43}----END RSA PRIVATE KEY-----'
      - '"-----BEGIN RSA PRIVATE KEY-----\n.{6}\.\.\."'
      - '-----BEGIN RSA PRIVATE KEY-----,$'
  - name: openssh-private-key-pem
    processor: pem
    pem-type: OPENSSH PRIVATE KEY
  - name: ec-private-key-pem
    processor: pem
    pem-type: EC PRIVATE KEY
  - name: rsa-private-key-block-pem
    processor: pem
    pem-type: PGP PRIVATE KEY BLOCK

  - name: entropy-base64
    processor: entropy
    entropy:
      charset: base64
      length-threshold: 20
      entropy-threshold: 4.5
    whitelist-code-match:
      - '\bssh-rsa AAAA[0-9A-Za-z+/]+[=]{0,3}\b'
      - 'https://github\.(com/repos/[^/]+/[^/]+/commit/[^/"\)]+)'
      - 'https://github\.(com/[^/]+/[^/]+/commit/[^/"\)]+)'
      - 'https://api\.github\.(com/repos/[^/]+/[^/]+/zipball/[^/"]+)'
      - 'https://api\.github\.(com/repos/[^/]+/[^/]+/zipball/[^/"]+)'
      - 'https://[^\.]+\.atlassian\.(net/wiki/display/[^/]+/[A-Za-z0-9\+]+)'
      - '(0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz)'
      - '(abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ)'
      - '(abcdefghijklmnopqrstuvwxyz0123456789)'
      - '(ABCDEFGHIJKLMNOPQRSTUVWXYZ)'
      - '(abcdefghijklmnopqrstuvwxyz)'
      - 'ComposerStaticInit([^:\(]+)'
      - '(validEmptyBlockContainers=CKEDITOR)'
      - '''form_action_[^_]+_[^_]+_([^'']+)'''
      - '(com/g/[^/]+/[^/]+/badges/quality)'

  - name: entropy-hex
    processor: entropy
    entropy:
      charset: hex
      length-threshold: 20
      entropy-threshold: 3
    whitelist-code-match:
      # Commit hash in requirements.txt
      - '-e git\+https://[^\s\/]+/[^\s\/]+/[^\s\/]+\.git@'
      - 'git_ref\] = ''([^'']+)'''
